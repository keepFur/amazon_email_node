"use strict";function _defineProperty(t,e,a){return e in t?Object.defineProperty(t,e,{value:a,enumerable:!0,configurable:!0,writable:!0}):t[e]=a,t}layui.use(["element","table","layer","util","form"],function(){var t,e=layui.element,s=layui.table,r=layui.layer,a=layui.util,n=layui.form,i={netErrMsg:"系统已退出登录，请登录系统重试",operatorErrMsg:{single:"请选择一条数据操作",batch:"请至少选择一条数据操作"},taskPlants:["TB","JD","PDD"],tabIndex:0};function l(t){var e,a,n=(e=$("#taskSearchForm").serializeArray(),a={},$.each(e,function(t,e){a[e.name]=e.value}),a);return k($.extend(n,{taskPlant:i.taskPlants[i.tabIndex],page:{curr:1,limit:10}})),!1}function u(t){return $(".flyer-layout-tree .flyer-layout-link[data-hash=task_create]").click(),!1}function c(t){var a=s.checkStatus("taskTable").data;return 1===a.length?r.confirm("确定取消任务吗？状态会稍微有点延时，谢谢谅解！！取消之后金额将会退回账户中，请注意查看！！",{title:"询问框",btn:["确定","取消"]},function(t,e){APIUtil.cancelTask(a[0].taskOrderNumber,function(t){"1"===t.data.status?(r.msg("操作成功!"),$.ajax({url:"/api/toggleTask",type:"POST",data:{id:a[0].id,status:3,count:a[0].taskSumMoney,taskOrderNumber:a[0].taskOrderNumber,taskUserId:a[0].taskUserId},success:function(t,e,a){k()},error:function(t,e,a){r.msg(i.netErrMsg)}})):r.msg(t.data.tips)})}):r.msg(i.operatorErrMsg.single),!1}function o(t){var a=s.checkStatus("taskTable").data,n=t.data.type,e=0===n?"确定暂停吗？状态会稍微有点延时，谢谢谅解！！":"确定恢复吗？状态会稍微有点延时，谢谢谅解！！";return 1===a.length?r.confirm(e,{title:"询问框",btn:["确定","取消"]},function(t,e){APIUtil.pauseAndResumeTask(a[0].taskOrderNumber,n,function(t){"1"===t.data.status?(r.msg("操作成功！"),$.ajax({url:"/api/toggleTask",type:"POST",data:{id:a[0].id,status:n?1:2},success:function(t,e,a){k()},error:function(t,e,a){r.msg(i.netErrMsg)}})):r.msg("操作失败："+t.data.tips)})}):r.msg(i.operatorErrMsg.single),!1}function d(t){var a=s.checkStatus("taskTable").data;if(1===a.length)return 1===a[0].status?r.confirm("确定将任务标记为已完成吗？此操作不会影响任务的处理，只是为了方便管理！！",{title:"询问框",btn:["确定","取消"]},function(t,e){$.ajax({url:"/api/toggleTask",type:"POST",data:{id:a[0].id,status:4},success:function(t,e,a){t.success?(r.msg("操作成功"),k()):r.msg("操作失败:"+t.message)},error:function(t,e,a){r.msg(i.netErrMsg)}})}):r.msg("只可以标记处理中的任务"),!1;r.msg(i.operatorErrMsg.single)}function f(t){return $.get("/api/readAllProcessTask",function(a){a.data.rows.length?r.confirm("当前共有 "+a.data.rows.length+" 条处理中的任务,确定更新吗？<br>此操作不会产生任何不良影响，请放心操作！",{title:"询问框",btn:["确定","取消"]},function(t,e){APIUtil.listTask({id:a.data.rows.map(function(t){return t.taskOrderNumber}).join(",")},function(t){if("1"!==t.data.status)r.msg(t.data.tips);else if(t.data.list&&0<t.data.list.l.length){var n=t.data.list.l.filter(function(t){return 1==t.s}).map(function(t){return t.i});n.length?$.ajax({url:"/api/maskCompleteTask",type:"POST",data:{id:n.join(","),status:4},success:function(t,e,a){t.success?(r.msg("操作成功,共同步（"+n.length+"）条任务"),k()):r.msg("操作失败:"+t.message)},error:function(t,e,a){r.msg(i.netErrMsg)}}):r.msg("所有任务都已更新到最新状态")}else r.msg("查无此订单信息")})}):r.msg("暂时没有处理中的任务")}),!1}function k(t){s.reload("taskTable",{where:t})}n.render("select"),s.render((_defineProperty(t={elem:"#taskTable",url:"/api/readTaskPage",page:!0,where:{plant:"TB"},cols:[[{checkbox:!0,fixed:"left"},{field:"",title:"序号",fixed:"left",templet:function(t){return t.LAY_INDEX}},{field:"taskOrderNumber",title:"订单号",width:220},{field:"taskUserName",title:"下单用户",width:150},{field:"taskQuantity",title:"关键词/数量",width:200,templet:function(t){return"（"+(t.taskKeyword||"-")+"）"+t.taskQuantity+"个 "}},{field:"taskSumMoney",title:"消费金额",width:100,templet:function(t){return core.fenToYuan(t.taskSumMoney)+" 元"}},{field:"plant",title:"平台/任务类型",width:250,templet:function(t){return core.getPlantByCode(t.taskPlant)+"（"+t.taskTypeName+"）"}},{field:"taskName",title:"任务名称",width:200},{field:"taskBabyLinkToken",title:"宝贝链接",width:250,templet:function(t){return'<a href="'+t.taskBabyLinkToken+'" style="color:#2cc3a9" target="_blank">'+t.taskBabyLinkToken+"</a>"}},{field:"taskStartDate",title:"任务开始日期",width:120,templet:function(t){return a.toDateString(t.createdDate,"yyyy-MM-dd")}},{field:"createdDate",title:"订单创建时间",width:200,templet:function(t){return a.toDateString(t.createdDate,"yyyy-MM-dd HH:mm")}},{field:"status",title:"处理状态",width:150,fixed:"right",align:"center",templet:function(t){return'<span class="layui-text-'+(1==t.status?"green":"pink")+'">'+["","处理中","已暂停","已取消","已完成"][t.status]+'</span> <a class="layui-btn layui-btn-normal layui-btn-xs js-view-status" data-id=" '+t.id+'" data-task-order-number="'+t.taskOrderNumber+'">查看详情</a>'}}]],limits:[10,20,50,100]},"page",{theme:"#1E9FFF",layout:["prev","page","next","skip","count","limit"]}),_defineProperty(t,"request",{pageName:"offset"}),_defineProperty(t,"response",{statusCode:!0}),_defineProperty(t,"parseData",function(t){return{code:t.success,msg:t.msg,count:t.data.total,data:t.data.rows}}),_defineProperty(t,"done",function(t){$(".js-view-status").off("click").on("click",function(a){var n=$(this).data("task-order-number"),s="";APIUtil.listTask({id:n},function(t){if("1"!==t.data.status)s=t.data.tips;else if(t.data.list&&0<t.data.list.l.length){var e=t.data.list.l[0];s="任务单号："+n+"</br>任务状态："+e.m.replace(/\(已退款\)|\(部分退款\)/,"")+"</br>任务总量："+e.c+"</br>剩余量："+e.e+"</br></br>PS：此处的状态会有稍微的延时，敬请谅解！！"}else s="查无此订单信息，如有疑问，请联系客服人员解决！";r.tips(s,a.target,{tips:1})})})}),t)),e.on("tab(manageTask)",function(t){t.index!==i.tabIndex&&(k({taskPlant:i.taskPlants[t.index]}),i.tabIndex=t.index)}),$("#searchBtn").on("click",l),$("#resetBtn").on("click",function(){return $("#taskSearchForm")[0].reset(),!1}),$("#createTaskBtn").on("click",u),$("#cancelTaskBtn").on("click",c),$("#disabledTaskBtn").on("click",{type:0},o),$("#enabledTaskBtn").on("click",{type:1},o),$("#completeTaskBtn").on("click",d),$("#asyncTaskBtn").on("click",f)});