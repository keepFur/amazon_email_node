"use strict";layui.use(["element","layer","laydate","form"],function(){var t=layui.element,d=layui.layer,e=layui.laydate,a=layui.form,y=$("#userName").data("user"),l=($("#userName").data("user-id"),{tabIndex:0,tabText:"TB",taskTypeInfo:null});function n(t){if(5===$(".js-keyword-quantity-container").find(".js-keyword-quantity-item").length)return d.msg("主人，你够了！"),!1;var e=$(t.target).parents(".js-keyword-quantity-container"),a=$(t.target).parents(".js-keyword-quantity-item").clone(!0);return e.append(a),a.find("input[name=taskKeyword]").val(""),a.find("input[name=taskQuantity]").val(""),a.find("input[name=taskHour]").val(""),o(),!1}function r(a){$("#setTaskHourContainer input").each(function(t,e){(e=$(e)).val(a[t])})}function o(){var t=$(".js-keyword-quantity-container").find(".js-keyword-quantity-item");$.each(t,function(t,e){var a=t+1;$(e).find(".js-task-keyword").text("关键词"+a),$(e).find(".js-task-quantity").text("数量"+a),$(e).find(".js-task-hour").text("时段"+a)})}function i(t){var e=$(".js-keyword-quantity-container").find(".js-keyword-quantity-item"),a=$(t.target).parents(".js-keyword-quantity-item");return 1===e.length?d.msg("主人，必须留个种啊！"):(a.remove(),o()),!1}function s(t){if(!l.taskTypeInfo)return d.msg("请先选择任务类型"),!1;var e,a,n,r=t.target,o=$("form[name=taskForm]"),i=(e=o,a={},n=k(),a.taskUserId=$("#userName").data("user-id"),a.taskParentType=l.tabText,a.taskUnitPrice=l.taskTypeInfo.price,a.taskPlant=l.taskTypeInfo.plant,a.keywordQuantity=n,$.extend(core.getFormValues(e),a));i.taskStartDate=i.taskStartDate||$.formatDate("yyyy-mm-dd");var s=function(t){if(!t)return $.writeLog("tb_task-validTaskInfo","参数为空"),{isPass:!1,msg:"参数不能为空"};if(y.money<=0||y.money<core.computeTotalPriceTask(l.level,t.taskSumMoney))return{isPass:!1,msg:"主人，您的余额不足，请先充值，谢谢！！！"};if(!l.taskTypeInfo)return{isPass:!1,msg:"请先选择任务类型"};if(!t.taskName)return{isPass:!1,msg:"任务名称不能为空"};if(!t.taskBabyLinkToken)return{isPass:!1,msg:"宝贝链接不能为空"};if(!t.taskGoodsBrowsingTime||isNaN(t.taskGoodsBrowsingTime)||t.taskGoodsBrowsingTime<50)return{isPass:!1,msg:"商品浏览时间不能低于50秒"};if(!t.taskKeyword&&l.taskTypeInfo.hask)return{isPass:!1,msg:"关键词不能为空"};return{isPass:!0,msg:""}}(i);if(s.isPass)if(l.taskTypeInfo.hask)for(var u=0;u<i.keywordQuantity.length;u++)!function(a){i.taskKeyword=i.keywordQuantity[a].keyword,i.taskQuantity=i.keywordQuantity[a].quantity,i.taskHour=i.keywordQuantity[a].hour,i.taskSumMoney=i.taskUnitPrice*i.taskQuantity;var t=m(i);APIUtil.createTask(t,function(t,e){return e?(d.msg(e.message),!1):"1"!==t.data.status?(d.msg(t.data.tips),!1):(i.taskOrderNumber=t.orderNumber,i.taskKeyword=i.keywordQuantity[a].keyword,i.taskQuantity=i.keywordQuantity[a].quantity,i.taskHour=i.keywordQuantity[a].hour,i.taskSumMoney=i.taskUnitPrice*i.taskQuantity,void $.ajax({url:"/api/createTask",type:"POST",data:i,async:!1,beforeSend:function(t,e){$.lockedBtn($(r),!0,"创建中")},success:function(t,e,a){t.success?(d.msg("操作成功！！！"),core.getUserInfoById(function(t){y=t.data.rows[0],$("#userName").data("user",JSON.stringify(t))}),core.setWindowHash("manage_task?taskType="+l.tabText)):APIUtil.cancelTask(i.taskOrderNumber,function(t){d.msg("操作失败："+t.data.tips)})},error:function(t,e,a){d.msg(l.errorMsg)},complete:function(t,e){$.unlockBtn($(r),'<i class="layui-icon layui-icon-release"></i>创建任务')}}))})}(u);else{i.taskKeyword="",i.taskQuantity=i.taskQuantityNoKeyword,i.taskHour=f(i.taskQuantity,p()),i.taskSumMoney=i.taskUnitPrice*i.taskQuantity;var c=m(i);APIUtil.createTask(c,function(t,e){return e?(d.msg(e.message),!1):"1"!==t.data.status?(d.msg(t.data.tips),!1):(i.taskOrderNumber=t.orderNumber,void $.ajax({url:"/api/createTask",type:"POST",data:i,beforeSend:function(t,e){$.lockedBtn($(r),!0,"创建中")},success:function(t,e,a){t.success?(d.msg("操作成功！！！"),core.getUserInfoById(function(t){y=t.data.rows[0],$("#userName").data("user",JSON.stringify(t))}),core.setWindowHash("manage_task?taskType="+l.tabText)):APIUtil.cancelTask(i.taskOrderNumber,function(t){d.msg("操作失败："+t.data.tips)})},error:function(t,e,a){d.msg(l.errorMsg)},complete:function(t,e){$.unlockBtn($(r),'<i class="layui-icon layui-icon-release"></i>创建任务')}}))})}else d.msg(s.msg);return!1}function k(){var o=[],t=$(".js-keyword-quantity-container").find(".js-keyword-quantity-item");return $.each(t,function(t,e){var a=$(e).find("input[name=taskKeyword]").val(),n=$(e).find("input[name=taskHour]").val(),r=Number($(e).find("input[name=taskQuantity]").val());a&&0<r&&(n=n&&24===n.split(",").length?n.split(","):f(r,p()),o[t]={keyword:a,quantity:r,hour:n})}),o}function m(t){var e={};return e.begin_time=t.taskStartDate||$.formatDate("yyyy-mm-dd"),e.type=l.taskTypeInfo.code,e.count=t.taskQuantity,e.target=t.taskBabyLinkToken,e.keyword=t.taskKeyword,e.sUrl=t.sUrl,e.hour=t.taskHour.join(","),e.goodsBrowsingTime=t.taskGoodsBrowsingTime,e}function f(t,e){var a,n,r=new Array(24).fill(0),o=24-e;return isNaN(t)||isNaN(e)?[]:(n=t-(a=t%e),r.fill(n/e,o,24),r[23]+=a,r)}function p(){return 24-(new Date).getHours()}function u(t){$.get("/api/readTaskType?status=1&plant="+t,function(t){var e,i;e=t.data.rows,(i=$("select[name=taskChildType]")).empty(),i.append('<option value="">请选择任务类型</option>'),$.each(e,function(t,e){var a=core.fenToYuan(core.computeTotalPriceTask(l.level,e.outPrice)),n=core.fenToYuan(core.computeTotalPriceTask(1,e.outPrice)),r=core.fenToYuan(core.computeTotalPriceTask(2,e.outPrice)),o=["","普通会员","金牌会员","内部会员"][l.level];i.append('<option value="'+e.id+'" data-name="'+e.name+'" data-hask="'+e.hasKeyword+'" data-code="'+e.lieliuCode+'" data-price="'+e.outPrice+'" data-plant="'+e.plant+'">'+e.name+"，你的价格（"+o+"）："+a+"元，普通会员："+n+"元，金牌会员："+r+"元</option>")}),a.render("select")},"json")}t.on("tab(createTask)",function(t){t.index!==l.tabIndex&&(l.tabIndex=t.index,l.tabText=$(this).data("task-parent-type"),u(l.tabText),$("form[name=taskForm]").find(".js-task-search-index").toggle(0===t.index))}),a.on("select(taskChildType)",function(t){if(t.value){var e=$(t.elem).find("option[value="+t.value+"]"),a=e.data("price"),n=e.data("plant"),r=e.data("name"),o=e.data("code"),i=e.data("hask"),s=$("input[name=taskQuantityNoKeyword]").val();l.taskTypeInfo={price:a,plant:n,name:r,code:o,hask:i},$("#taskPrice").text(core.fenToYuan(a)),$("#discountTaskPrice").text(core.fenToYuan(core.computeTotalPriceTask(l.level,a)));var u=k().reduce(function(t,e){return t+e.quantity},0),c=u&&l.taskTypeInfo.hask?u*l.taskTypeInfo.price:s*l.taskTypeInfo.price;$("#taskSumMoney").text(core.fenToYuan(c)),$("#discountTaskSumMoney").text(core.fenToYuan(core.computeTotalPriceTask(l.level,c))),$(".js-keyword-quantity-container").toggle(!!i),$(".js-no-keyword-container").toggle(!i)}else l.taskTypeInfo=null;$("input[name=taskGoodsBrowsingTime]").val(50)}),$("input[name=taskQuantity],input[name=taskQuantityNoKeyword]").on("keyup",function(t){var e=this.value;if(!l.taskTypeInfo)return!1;if(!isNaN(e)&&0<e){var a=k().reduce(function(t,e){return t+e.quantity},0),n=a&&l.taskTypeInfo.hask?a*l.taskTypeInfo.price:e*l.taskTypeInfo.price;$("#taskSumMoney").text(core.fenToYuan(n)),$("#discountTaskSumMoney").text(core.fenToYuan(core.computeTotalPriceTask(l.level,n)))}else this.value=""}),$(".js-delete-time").on("click",function(){var t=$("input[name=taskGoodsBrowsingTime]"),e=$("input[name=taskQuantityNoKeyword]").val();if(!l.taskTypeInfo)return d.msg("请先选择任务类型"),!1;if(t.val()<=50)return d.msg("不能低于50秒"),!1;t.val(t.val()-10),l.taskTypeInfo.price-=10,$("#taskPrice").text(core.fenToYuan(l.taskTypeInfo.price)),$("#discountTaskPrice").text(core.fenToYuan(core.computeTotalPriceTask(l.level,l.taskTypeInfo.price)));var a=k().reduce(function(t,e){return t+e.quantity},0),n=a&&l.taskTypeInfo.hask?a*l.taskTypeInfo.price:e*l.taskTypeInfo.price;return $("#taskSumMoney").text(core.fenToYuan(n)),$("#discountTaskSumMoney").text(core.fenToYuan(core.computeTotalPriceTask(l.level,n))),!1}),$(".js-add-time").on("click",function(){var t=$("input[name=taskGoodsBrowsingTime]"),e=$("input[name=taskQuantityNoKeyword]").val();if(!l.taskTypeInfo)return d.msg("请先选择任务类型"),!1;if(120<=t.val())return d.msg("不能高于120秒"),!1;t.val(10+(0|t.val())),l.taskTypeInfo.price+=10,$("#taskPrice").text(core.fenToYuan(l.taskTypeInfo.price)),$("#discountTaskPrice").text(core.fenToYuan(core.computeTotalPriceTask(l.level,l.taskTypeInfo.price)));var a=k().reduce(function(t,e){return t+e.quantity},0),n=a&&l.taskTypeInfo.hask?a*l.taskTypeInfo.price:e*l.taskTypeInfo.price;return $("#taskSumMoney").text(core.fenToYuan(n)),$("#discountTaskSumMoney").text(core.fenToYuan(core.computeTotalPriceTask(l.level,n))),!1}),$("input[name=taskHour]").on("click",function(t){var o=$(this),e=function(){function t(t,e){for(var a='<tr class="layui-table-nohover">',n=t;n<e;n++)a+='<td style="padding-left:8px;padding-right:8px;">'+core.padStart(n)+":00</td>";return a+"</tr>"}function e(t){for(var e='<tr class="layui-table-nohover">',a=0;a<t;a++)e+='<td style="padding:0 8px;">\n                                <div class="layui-input-inline" style="padding-top:0;padding-bottom:8px;">\n                                    <input class="layui-input" type="text" value="0"\n                                    style="border: none;border-bottom: 1px solid rgba(0,0,0,.42);border-radius: 0;"/>\n                                </div>\n                            </td>';return e+"</tr>"}for(var a="",n=0;n<6;n++)a+=n%2==0?t(8*(n-n/2),8*(1+n/2)):e(8);return'<div id="setTaskHourContainer">\n                        <table class="layui-table">\n                            <tbody>\n                            '+a+"\n                            </tbody>\n                        </table>\n                    </div>"}(),i=o.parents(".js-keyword-quantity-item").find("input[name=taskQuantity]").val(),s=o.parents(".js-keyword-quantity-item").find("input[name=taskKeyword]").val();if(!i||!s)return d.msg("关键词和数量不能为空"),!1;var a=o.val().split(","),u=d.open({title:"设置任务时段（"+s+"/"+i+"）",content:e,area:["720px"],btn:["确定","重置","取消"],btn1:function(){var a,t,e,n=(a=[],$("#setTaskHourContainer input").each(function(t,e){e=$(e),a[t]=Number(isNaN(e.val())?0:e.val())}),a),r="关键词/数量（"+s+"/"+i+"）:</br>\n                                   00:00-07:00: "+n.slice(0,8).join(",")+"</br>\n                                   08:00-15:00: "+n.slice(8,16).join(",")+"</br>\n                                   16:00-23:00: "+n.slice(16).join(",");t=r,e=void 0,o.hover(function(){e=d.tips(t,o[0],{tips:1,time:0})},function(){d.close(e)}),o.val(n.join(",")),d.close(u),d.msg("设置成功")},btn2:function(){return r(f(i,p())),!1}});return 24===a.length?r(a):r(f(i,p())),function(t){for(var e=0;e<24-t;e++)$("#setTaskHourContainer input:eq("+e+")").attr("disabled",!0)}(p()),!1}),$("input[name=taskBabyLinkToken]").on("blur",function(t){var e="id",a="";return this.value.trim()?1===l.tabIndex||(2===l.tabIndex&&(e=l.taskTypeInfo.code&&93===l.taskTypeInfo.code?"mall_id":"goods_id"),(a=core.getQueryString(e,this.value)||"")&&(this.value=this.value.split("?")[0]+"?"+e+"="+a),0===l.tabIndex&&$.get("/api/getTbDetail?id="+a,function(t){"SUCCESS::调用成功"===t.ret[0]?($("#bbDetailContainer").removeClass("layui-hide"),$("#bbImgContainer").html('<img src="'+t.data.item.images[0]+'" width="100" height="100">'),$("#bbTitle").text("标题："+t.data.item.title),$("#bbShop").text("店铺："+t.data.seller.shopName),$("#bbSeller").text("卖家："+t.data.seller.sellerNick)):d.msg("服务器异常")},"json")):$("#bbDetailContainer").addClass("layui-hide"),!1}),$("button.js-add-keyword-quantity").on("click",n),$("button.js-delete-keyword-quantity").on("click",i),$("#createTask").on("click",s),e.render({format:"yyyy-MM-dd",elem:"#taskStartDate",min:$.formatDate("yyyy-mm-dd")}),e.render({format:"yyyy-MM-dd",elem:"#taskEndDate",min:$.formatDate("yyyy-mm-dd")}),a.render("radio"),a.render("select"),$("#taskStartDate").val($.formatDate("yyyy-mm-dd")),core.getUserInfoById(function(t){y=t.data.rows[0],l.level=y.level,u("TB"),$("#userName").data("user",JSON.stringify(t)),$("#userBalance").text(core.fenToYuan(y.money)),$("#userLevel").html(core.getLevelText(y.level)),$("#discountTaskSumMoneyText,#discountTaskPriceText").toggle(1!==y.level)})});