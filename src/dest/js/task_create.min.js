"use strict";layui.use(["element","layer","laydate","form"],function(){var t=layui.element,d=layui.layer,e=layui.laydate,i=layui.form,s=$("#userName").data("user"),o=$("#userName").data("user-id"),u={tabIndex:0,tabText:"TRFFIC"};function a(t){if(5===$(".js-keyword-quantity-container").find(".js-keyword-quantity-item").length)return d.msg("主人，你够了！"),!1;var e=$(t.target).parents(".js-keyword-quantity-container"),a=$(t.target).parents(".js-keyword-quantity-item").clone(!0);return e.append(a),a.find("input[name=taskKeyword]").val(""),a.find("input[name=taskQuantity]").val(""),a.find("input[name=taskHour]").val(""),r(),!1}function n(a){$("#setTaskHourContainer input").each(function(t,e){(e=$(e)).val(a[t])})}function r(){var t=$(".js-keyword-quantity-container").find(".js-keyword-quantity-item");$.each(t,function(t,e){var a=t+1;$(e).find(".js-task-keyword").text("关键词"+a),$(e).find(".js-task-quantity").text("数量"+a),$(e).find(".js-task-hour").text("时段"+a)})}function y(t){var e=$(".js-keyword-quantity-container").find(".js-keyword-quantity-item"),a=$(t.target).parents(".js-keyword-quantity-item");return 1===e.length?d.msg("主人，必须留个种啊！"):(a.remove(),r()),!1}function k(t){var n=t.target,r=function(t){var e={},a=core.getTypeCodeByValue($("input[name=taskChildType]:checked").val()),n=c();n.reduce(function(t,e){return t+e.quantity},0);return e.taskUserId=$("#userName").data("user-id"),e.taskParentType=u.tabText,e.taskUnitPrice=a.price,e.taskPlant=a.plant,e.keywordQuantity=n,$.extend(core.getFormValues(t),e)}($("form[name=taskForm]"));r.taskStartDate=r.taskStartDate||$.formatDate("yyyy-mm-dd");var e=function(t){if(s.money<=0||s.money<t.taskSumMoney)return{isPass:!1,msg:"主人，您的积分不足，请先充值，谢谢！"};if(!t)return $.writeLog("tb_task-setTaskDetail","参数为空"),{isPass:!1,msg:"参数不能为空"};if(!t.taskName)return{isPass:!1,msg:"任务名称不能为空"};if(!t.taskBabyLinkToken)return{isPass:!1,msg:"宝贝链接不能为空"};if(!t.taskGoodsBrowsingTime||isNaN(t.taskGoodsBrowsingTime)||t.taskGoodsBrowsingTime<50)return{isPass:!1,msg:"商品浏览时间不能低于50秒"};return t.taskKeyword?{isPass:!0,msg:""}:{isPass:!1,msg:"关键词不能为空"}}(r);if(e.isPass)for(var a=0;a<r.keywordQuantity.length;a++)!function(a){r.taskKeyword=r.keywordQuantity[a].keyword,r.taskQuantity=r.keywordQuantity[a].quantity,r.taskHour=r.keywordQuantity[a].hour,r.taskSumMoney=r.taskUnitPrice*r.taskQuantity;var t=l(r);APIUtil.createTask(t,function(t,e){return e?(d.msg(e.message),!1):"1"!==t.data.status?(d.msg(t.data.tips),!1):(r.taskOrderNumber=t.orderNumber,r.taskKeyword=r.keywordQuantity[a].keyword,r.taskQuantity=r.keywordQuantity[a].quantity,r.taskHour=r.keywordQuantity[a].hour,r.taskSumMoney=r.taskUnitPrice*r.taskQuantity,void $.ajax({url:"/api/createTask",type:"POST",data:r,beforeSend:function(t,e){$.lockedBtn($(n),!0,"创建中")},success:function(t,e,a){t.success?(d.msg("操作成功！！！</br>本次共消费积分："+r.taskSumMoney+"</br>积分余额："+(s.money-r.taskSumMoney)),core.getUserInfoById(o,function(t){s=t.data.rows[0],$("#userName").data("user",JSON.stringify(t))}),core.setWindowHash("manage_task")):APIUtil.cancelTask(r.taskOrderNumber,function(t){d.msg("操作失败："+t.data.tips)})},error:function(t,e,a){d.msg(u.errorMsg)},complete:function(t,e){$.unlockBtn($(n),'<i class="layui-icon layui-icon-release"></i>创建任务')}}))})}(a);else d.msg(e.msg);return!1}function c(){var i=[],t=$(".js-keyword-quantity-container").find(".js-keyword-quantity-item");return $.each(t,function(t,e){var a=$(e).find("input[name=taskKeyword]").val(),n=$(e).find("input[name=taskHour]").val(),r=Number($(e).find("input[name=taskQuantity]").val());a&&0<r&&(n=n&&24===n.split(",").length?n.split(","):m(r,f()),i[t]={keyword:a,quantity:r,hour:n})}),i}function l(t){var e={};return e.begin_time=t.taskStartDate||$.formatDate("yyyy-mm-dd"),e.type=core.getTypeCodeByValue(t.taskChildType).code,e.count=t.taskQuantity,e.target=t.taskBabyLinkToken,e.keyword=t.taskKeyword,e.sUrl=t.sUrl,e.hour=t.taskHour.join(","),e.goodsBrowsingTime=t.taskGoodsBrowsingTime,e}function m(t,e){var a,n,r=new Array(24).fill(0),i=24-e;return isNaN(t)||isNaN(e)?[]:(n=t-(a=t%e),r.fill(n/e,i,24),r[23]+=a,r)}function f(){return 24-(new Date).getHours()}t.on("tab(createTask)",function(t){var e,a,n,r;t.index!==u.tabIndex&&(e=$(this),a=$(".js-task-index"),n=$("form[name=taskForm]").find(".js-task-search-index"),r=e.data("index"),a.addClass("layui-hide").find("input[type=radio]").prop("checked",!1),a.eq(r).removeClass("layui-hide").find("input[type=radio]").first().prop("checked",!0),n.toggle(0===r||1==r),i.render("radio"),u.tabIndex=t.index,u.tabText=$(this).data("task-parent-type"))}),i.on("radio",function(t){if("taskChildType"===this.name){var e=$("input[name=taskQuantity]").val();$("#taskPrice").text(core.getTypeCodeByValue(this.value).price),e&&$("#taskSumMoney").text(core.numberToLocalString($("#taskPrice").text()*e))}}),$("input[name=taskQuantity]").on("keyup",function(t){var e=this.value;if(!isNaN(e)&&0<e){var a=c().reduce(function(t,e){return t+e.quantity},0);$("#taskSumMoney").text(core.numberToLocalString(a*$("#taskPrice").text()))}else this.value=""}),$("input[name=taskHour]").on("click",function(t){var i=$(this),e=function(){function t(t,e){for(var a='<tr class="layui-table-nohover">',n=t;n<e;n++)a+='<td style="padding-left:8px;padding-right:8px;">'+core.padStart(n)+":00</td>";return a+"</tr>"}function e(t){for(var e='<tr class="layui-table-nohover">',a=0;a<t;a++)e+='<td style="padding:0 8px;">\n                                <div class="layui-input-inline" style="padding-top:0;padding-bottom:8px;">\n                                    <input class="layui-input" type="text" value="0"\n                                    style="border: none;border-bottom: 1px solid rgba(0,0,0,.42);border-radius: 0;"/>\n                                </div>\n                            </td>';return e+"</tr>"}for(var a="",n=0;n<6;n++)a+=n%2==0?t(8*(n-n/2),8*(1+n/2)):e(8);return'<div id="setTaskHourContainer">\n                        <table class="layui-table">\n                            <tbody>\n                            '+a+"\n                            </tbody>\n                        </table>\n                    </div>"}(),s=i.parents(".js-keyword-quantity-item").find("input[name=taskQuantity]").val(),o=i.parents(".js-keyword-quantity-item").find("input[name=taskKeyword]").val();if(!s||!o)return d.msg("关键词和数量不能为空"),!1;var a=i.val().split(","),u=d.open({title:"设置任务时段（"+o+"/"+s+"）",content:e,area:["720px"],btn:["确定","重置","取消"],btn1:function(){var a,t,e,n=(a=[],$("#setTaskHourContainer input").each(function(t,e){e=$(e),a[t]=Number(isNaN(e.val())?0:e.val())}),a),r="关键词/数量（"+o+"/"+s+"）:</br>\n                                   00:00-07:00: "+n.slice(0,8).join(",")+"</br>\n                                   08:00-15:00: "+n.slice(8,16).join(",")+"</br>\n                                   16:00-23:00: "+n.slice(16).join(",");t=r,e=void 0,i.hover(function(){e=d.tips(t,i[0],{tips:1,time:0})},function(){d.close(e)}),i.val(n.join(",")),d.close(u),d.msg("设置成功")},btn2:function(){return n(m(s,f())),!1}});return 24===a.length?n(a):n(m(s,f())),function(t){for(var e=0;e<24-t;e++)$("#setTaskHourContainer input:eq("+e+")").attr("disabled",!0)}(f()),!1}),$("input[name=taskBabyLinkToken]").on("blur",function(t){return this.value=core.getQueryString("goods_id",this.value),!1}),$("button.js-add-keyword-quantity").on("click",a),$("button.js-delete-keyword-quantity").on("click",y),$("#createTask").on("click",k),e.render({format:"yyyy-MM-dd",elem:"#taskStartDate",min:$.formatDate("yyyy-mm-dd")}),i.render("radio"),$("#taskStartDate").val($.formatDate("yyyy-mm-dd")),$("#taskPrice").text(core.getTypeCodeByValue($("input[type=radio][name=taskChildType]:checked").val()).price),core.getUserInfoById(o,function(t){s=t.data.rows[0],$("#userName").data("user",JSON.stringify(t))})});