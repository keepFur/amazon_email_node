"use strict";layui.use(["element","layer","form"],function(){layui.element;var o=layui.layer,t=layui.form,i=.1,d=.05;function r(e){var a=$(e),n=a.data("purchase-score"),t=a.data("present-score"),r=n+t,o=a.data("purchase-money")+a.data("present-money"),c=o/d,s=o/i;$("#purchaseMoney").text(core.numberToLocalString(o)),$("#purchaseScore").text(core.numberToLocalString(r)),$("#trafficCount").text(core.numberToLocalString(c)),$("#collectCount").text(core.numberToLocalString(s)),$("#addScore").text(core.numberToLocalString(n)+"购买积分+"+core.numberToLocalString(t)+"赠送积分"),$("#payMoney").text(core.numberToLocalString(a.data("purchaseMoney")))}function e(e){var a=$("input[type=radio][name=addPackageType]:checked"),r={};o.open({content:'<div class="js-pay-container">\n                            <h3 style="text-align:center;">打开微信或者支付宝扫一扫即可付款</h3>\n                            <div>\n                                <img width="100%" height="330" alt="付款码" id="jsPayCodeImg">\n                                <button class="layer-btn layer-btn-normal" id="jsPayCodeRefresh" style="display:none;">刷新</button>\n                            </div>\n                            <div>\n                                <span class="pull-left">付款金额：<spam id="payMount">100</spam>元</span>\n                                <span class="pull-right">收款人：易店科技</span>\n                            </div>\n                        </div>',area:["450px","520px"],title:"在线充值付款",btn:"支付完成",scrollbar:!1,yes:function(a,n){$.lockedBtn(n.find(".layui-layer-btn0"),!0,"支付状态检测中");var t=0;clearInterval(r.timer),r.timer=setInterval(function(){++t<5?l(r.qr_id,r.addPackageType,function(e){o.closeAll("msg"),e?(r.payStatus=!0,clearInterval(r.timer),o.msg("支付成功"),$.unlockBtn(n.find(".layui-layer-btn0"),"支付完成"),o.close(a),core.setWindowHash("manage_logs"),window.location.reload(!0)):5===t&&o.msg("订单未支付")}):clearInterval(r.timer)},0===t?0:1e4)},cancel:function(){r.payStatus||l(r.qr_id,r.addPackageType,function(e){o.closeAll("msg"),e?(o.msg("支付成功"),core.setWindowHash("manage_logs"),window.location.reload(!0)):o.msg("订单未支付")})},success:function(n,t){$("#payMount").text(a.data("purchase-money")),$.ajax({url:"/api/createQrCode",type:"POST",data:{qr_name:"余额充值",packageId:a.val(),qr_type:"QR_TYPE_NOLIMIT"},beforeSend:function(){$.addLoading($(".js-pay-container"))},success:function(e){if($("#jsPayCodeImg").toggle(e.success),$("#jsPayCodeRefresh").toggle(!e.success),e.success){$("#jsPayCodeImg").attr("src",e.data.qr_code),r.qr_id=e.data.qr_id,r.addPackageType=$("input[type=radio][name=addPackageType]").val();var a=0;r.timer=setInterval(function(){$.lockedBtn(n.find(".layui-layer-btn0"),!0,"支付状态检测中"),++a<5?l(r.qr_id,r.addPackageType,function(e){o.closeAll("msg"),e?(r.payStatus=!0,clearInterval(r.timer),o.msg("支付成功，正在为你跳转到首页。。。"),$.unlockBtn(n.find(".layui-layer-btn0"),"支付完成"),o.close(t),core.setWindowHash("manage_logs"),window.location.reload(!0)):5===a&&o.msg("订单未支付")}):clearInterval(r.timer)},1e4)}},error:function(){o.msg(baseDatas.netErrMsg)},complete:function(){$.removeLoading($(".js-pay-container"))}})}});return!1}function c(e){var n='<div class="layui-input-block">';$.each(e,function(e,a){e%4==0&&0!==e&&(n+='</div><div class="layui-input-block">'),n+=s(a,0===e)}),n+="</div>",$(".js-add-package-type-container").html(n),t.render("radio")}function s(e,a){return'<input type="radio" name="addPackageType"\n                    '+(a?"checked":"")+'\n                    value="'+e.id+'"\n                    data-purchase-score="'+e.packagePurchaseScore+'" \n                    data-present-score="'+e.packagePresentScore+'"\n                    data-purchase-money="'+e.packagePurchaseMoney+'" \n                    data-present-money="'+e.packagePresentMoney+'"\n                    title="'+e.packageName+'">\n                </input>'}function l(e,a,n){if(!e)return n(!1);$.ajax({url:"/api/getQrCodePayStatus",data:{qr_id:e,addPackageType:a,orderNumber:APIUtil.generateOrderNumer()},success:function(e){n(e.data.status)}})}$("form[name=addMoneyForm] input[name=userName]").val($("#userName").text().trim()),core.getUserInfoById($("#userName").data("user-id"),function(e){$("#userMainMoney").text(e.data.rows[0].money)}),$.ajax({url:"/api/readPackagePage",type:"GET",data:{limit:20,status:1,offset:1},beforeSend:function(e,a){$.addLoading()},success:function(e,a,n){e.success?(c(e.data.rows),t.on("radio",function(e){"addPackageType"===this.name&&r(e.elem)}),r($("input[type=radio][name=addPackageType]").first()[0])):(o.msg(e.message),c([]))},error:function(e,a,n){o.msg(baseDatas.netErrMsg)},complete:function(e,a){$.removeLoading()}}),t.render("checkbox"),$("#addMoney").on("click",e)});