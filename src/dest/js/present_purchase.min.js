"use strict";layui.use(["form","element","table","layer","util","upload"],function(){var o=layui.form,i=(layui.table,layui.layer),s=(layui.util,layui.element),e=layui.upload,l={$table:null,level:1,presentInfo:null,fromStockInfo:null,paramErrMsg:"参数错误，请刷新页面重试",netErrMsg:"系统已退出登录，请登录系统重试",operatorErrMsg:{single:"请选择一条数据操作",batch:"请至少选择一条数据操作"},prensentList:[],kdPrice:310},c={};function n(e){return!1}function t(e){var n=document.createElement("a");return n.href="/api/downloadTemplate?plant="+l.plant,n.click(),!1}function r(e){var n=$("textarea[name=addressTo]").val();if(!n)return i.msg("请先填写收货地址信息"),!1;var t=n.split(/\n{1,}/g),r=[],a=t.map(function(e){return $.trim(e)}).filter(function(e,n){return 4===e.split(/，|,/).length&&4===e.split(/，|,/)[2].split(/\s{1,}/g).length||(r.push('<span class="layui-text-pink">第'+(n+1)+"行</span>("+e+") \n"),!1)});return i.alert('总共<span class="layui-text-pink">'+t.length+'个</span>收货地址。 \n其中有效收货地址<span class="layui-text-pink">'+a.length+'个</span>\n，无效收货地址<span class="layui-text-pink">'+(t.length-a.length)+"个</span>"+(r.length?"，无效地址分别是在："+r.join("，")+"。烦请修改":"，非常好！！！")+"\n"),!1}function a(e){var s=$("textarea[name=addressTo]").val();return s?i.open({content:'<form class="layui-form layui-form-pane" name="getRealOrderForm">\n                            <div class="layui-form-item">\n                                <div class="layui-form-item layui-form-text">\n                                    <label class="layui-form-label">刷单订单的收件人姓名</label>\n                                    <div class="layui-input-block">\n                                        <textarea class="layui-textarea" placeholder="输入刷单订单的收件人姓名,一行一个，请严格按照此格式填写" name="condition"></textarea>\n                                    </div>\n                                </div>\n                            </div>\n                        </form>',title:"过滤真实订单",btn:["确定","取消"],area:["450px"],scrollbar:!1,yes:function(e){var n=$("textarea[name=condition]").val(),t=n.split(/\n{1,}/g),r=s.split(/\n{1,}/g),a=[];n?(i.msg("过滤成功"),i.close(e),a=r.filter(function(e){return-1!==t.indexOf(e.split(/，|,/)[0])}),$("textarea[name=addressTo]").val(a.join("\n")),$("textarea[name=addressTo]").trigger("blur")):i.msg("过滤条件不能为空")}}):i.msg("请先填写收货地址信息"),!1}function d(e){var r=core.getFormValues($("form[name=presentOrderForm]")),n=function(e){if(!e)return{isPass:!1,msg:"参数错误"};if(!l.fromStockInfo)return{isPass:!1,msg:"请先设置发货人信息"};if(c.money<=0||c.money<core.computeTotalPrice(l.level,e.total))return{isPass:!1,msg:"主人，您的余额不足，请先充值，谢谢！！！"};if(!e.present)return{isPass:!1,msg:"请选择需要购买的礼品"};if(!e.presentStock)return{isPass:!1,msg:"请选择发货仓库"};if(!e.addressTo)return{isPass:!1,msg:"请输入收货地址"};if(!e.addressTo.split(/\n{1,}/g).map(function(e){return $.trim(e)}).filter(function(e){return 4===e.split(/，|,/).length&&4===e.split(/，|,/)[2].split(/\s{1,}/g).length}).length)return{isPass:!1,msg:"请输入正确格式的收货地址"};return{isPass:!0,msg:""}}(r),a=e.target;if(n.isPass){r.addressTo=r.addressTo.split(/\n/g).filter(function(e){return!!e}).map(function(e){return $.trim(e)}),r.addressToPca=function(){var n=[];try{n=$("textarea[name=addressTo]").val().split("\n").filter(function(e){return!!e}).map(function(e){var n=e.split(/,|，/)[2],t=n.split(" ");return t[0]+"-"+t[1]+"-"+t[2]})}catch(e){n=[]}return n}(),r.addressFromName=l.fromStockInfo.fromName,r.addressFromPhone=l.fromStockInfo.fromPhone,r.total=l.presentInfo.price*r.addressTo.length,r.fromStockId=r.presentStock,r.pid=r.present,r.count=1,r.price=l.presentInfo.price;for(var t=0;t<r.addressTo.length;t++)!function(t){r.orderNumber=APIUtil.generateOrderNumer(),APIUtil.createPresentOrder({send_order_no:r.orderNumber,goodsid:r.pid,storesid:r.presentStock,num:1,receiver_name:r.addressTo[t].split(/,|，/)[0],receiver_phone:r.addressTo[t].split(/,|，/)[1],receiver_province:r.addressToPca[t].split("-")[0],receiver_city:r.addressToPca[t].split("-")[1],receiver_district:r.addressToPca[t].split("-")[2],receiver_address:r.addressTo[t].split(/,|，/)[2].split(" ")[3],sendname:r.addressFromName,sendphone:r.addressFromPhone},function(e,n){return console.log(e),n?(i.msg(n.message),!1):1!==e.code?(i.msg(l.netErrMsg),!1):(r.taskid=e.data.taskid,r.addressTo=[r.addressTo[t]],r.addressToPca=[r.addressToPca[t]],void $.ajax({url:"/api/createPresentOrder",type:"POST",data:r,beforeSend:function(){$.lockedBtn($(a),!0,"提交中")},success:function(e,n,t){i.msg(e.success?"操作成功":"操作失败："+e.message),e.success&&core.setWindowHash("manage_present_order")},error:function(e,n,t){i.msg(l.errorMsg)},complete:function(){$.unlockBtn($(a),'<i class="layui-icon layui-icon-release"></i>提交订单')}}))})}(t)}else i.msg(n.msg);return!1}function u(e){var n=$("input[name=fromName]").val().trim(),t=$("input[name=fromPhone]").val().trim();if(l.fromStockInfo&&l.fromStockInfo.fromName===n&&l.fromStockInfo.fromPhone===t)return i.msg("信息没有发生改变"),!1;if(!n)return i.msg("姓名不能为空"),!1;if(!t)return i.msg("手机号或者座机号不能为空"),!1;var r=l.fromStockInfo?"/api/updateFromUserInfoById":"/api/saveFromUserInfoById";return $.ajax({url:r,type:"post",data:{fromName:n,fromPhone:t,userId:c.id},dataType:"json",success:function(e){e.success?i.msg("操作成功"):i.msg("操作失败："+e.message)},error:function(e){i.msg("操作失败："+l.netErrMsg)}}),!1}function m(e){var t=$("select[name=present]");t.empty(),t.append('<option value="">请选择礼品</option>'),$.each(e,function(e,n){t.append('<option value="'+n.id+'" data-price="'+n.apiprice+'" data-name="'+n.name+'" '+(l.presentInfo&&n.id==l.presentInfo.id?"selected":"")+">礼品名称："+n.name+"，价格："+n.apiprice+"元</option>")});var n=core.fenToYuan(core.computeTotalPrice(l.level,l.kdPrice)),r=core.fenToYuan(core.computeTotalPrice(1,l.kdPrice)),a=core.fenToYuan(core.computeTotalPrice(2,l.kdPrice)),s=["","普通会员","金牌会员","内部会员"][l.level];$("#kdPrice").val("你的价格（"+s+"）："+n+"元，普通会员："+r+"元，金牌会员："+a+"元").data("price",n),o.render("select")}$("#createPresentOrderBtn").on("click",d),$("textarea[name=addressTo]").on("blur",function(e){var n=function(){var n=[];try{n=$("textarea[name=addressTo]").val().split("\n").filter(function(e){return!!e})}catch(e){n=[]}return n}().length,t=n&&l.presentInfo?n*(core.yuanToFen(l.presentInfo.price)+l.kdPrice):0;$("#kbQuantity").text(n),$("#kbSumMoney").text(core.fenToYuan(t));var r=core.computeTotalPrice(l.level,l.kdPrice),a=l.presentInfo&&n?core.fenToYuan(n*(core.yuanToFen(l.presentInfo.price)+r)):0;return $("#discountKbSumMoney").text(a),!1}),$("#importAddressExcelBtn").on("click",n),$("#downloadTemplateBtn").on("click",t),$("#formatAddressBtn").on("click",r),$("#getRealOrderBtn").on("click",a),$("#saveSetPurchaseInfoBtn").on("click",u),s.on("tab(presentPurchase)",function(){"presentPurchase"===this.getAttribute("lay-id")&&m(l.prensentList)}),o.on("select(present)",function(e){var n=$(e.elem).find("option[value="+e.value+"]"),t=n.data("price"),r=n.data("name");l.presentInfo={price:t,id:e.value,name:r},$("#kbPrice").text(core.fenToYuan(t)),$("#discountKbPrice").text(core.fenToYuan(core.computeTotalPrice(l.level,t)))}),core.getUserInfoById(function(e){c=e.data.rows[0],l.level=c.level,APIUtil.readPresentList({},function(e){1===e.code?(l.prensentList=e.data.goodslist,m(l.prensentList),function(e){for(var n=$(".list-container .layui-row"),t="",r=0;r<e.length;r++){var a=e[r];t+='<div class="layui-col-xs3">\n                                <div class="present-item" style="height:330px;" data-id="'+a.id+'" data-name="'+a.name+'" data-price="'+a.apiprice+'">\n                                    <div class="present-item-body" style="height:260px;">\n                                        <img src="./imgs/'+a.id+'.jpg" onerror="this.src=\'./imgs/nopic.jpg\'" width="100%" height="100%" alt="礼品">\n                                    </div>\n                                    <div class="present-item-footer">\n                                        <h5 style="margin-bottom:8px;">'+a.name+'</h5>\n                                        <div class="layui-row layui-col-space8">\n                                            <div class="layui-col-xs4">\n                                                <span style="color:red"> ¥'+a.apiprice+'</span>\n                                            </div>\n                                            <div class="layui-col-xs4">\n                                               \n                                            </div>\n                                            <div class="layui-col-xs4">\n                                                <button class="layui-btn layui-btn-normal layui-btn-sm purchaseBtn">立即下单</button>\n                                            </div>\n                                        </div>\n                                    </div>\n                                </div>\n                        </div>'}n.html(t),$(".addCollectBtn,.cancelCollectBtn").click(function(e){return i.msg("功能正在开发中，尽情期待。。。。"),!1}),$(".present-item").click(function(e){var n=$(this),t=n.data("id"),r=n.data("price"),a=n.data("name");return l.presentInfo={id:t,name:a,price:r},s.tabChange("presentPurchase","presentPurchase"),!1})}(l.prensentList)):i.msg(l.netErrMsg)}),$("#userName").data("user",JSON.stringify(e)),$("#userBalance").text(core.fenToYuan(c.money)),$("#userLevel").html(core.getLevelText(c.level)),$("#discountKbSumMoneyText,#discountKbPriceText").toggle(1!==c.level),$.get("/api/readFromUserInfoById?userId="+c.id,function(e){e.data.rows.length&&(l.fromStockInfo=e.data.rows[0],$("input[name=fromName]").val(l.fromStockInfo.fromName),$("input[name=fromPhone]").val(l.fromStockInfo.fromPhone))})}),APIUtil.readFromStock({},function(e){var n,t;1===e.code?(n=e.data.storelist,(t=$("select[name=presentStock]")).empty(),t.append('<option value="">请选择发货仓库</option>'),$.each(n,function(e,n){t.append('<option value="'+n.id+'"} '+(0==e?"selected":"")+">"+n.store_name+"</option>")}),o.render("select")):i.msg(l.netErrMsg)}),e.render({elem:"#importAddressExcelBtn",url:"/api/importAddressExcel",done:function(e){var n;e.success?(i.msg("数据解析成功！！"),$("textarea[name=addressTo]").val((n=e.data,n.map(function(e){return e.name+"，"+e.phone+"，"+e.province+" "+e.city+" "+e.area+" "+e.detail+"，"+e.email})).join("\n"))):i.msg("数据解析失败："+e.message),i.closeAll("loading")},before:function(e){i.load()},data:{plant:function(){return l.plant}},size:2048,accept:"file",exts:"xls|xlsx|csv",error:function(e){i.closeAll("loading"),i.msg("数据解析失败:服务器异常！！！")}})});